---
import Layout from './Layout.astro';
import TableOfContents from '../components/core/navigation/TableOfContents.astro';
import { getAllMenuData } from '../utils/menuDataOptimized.js';
import VisaSidebarFilters from '../components/features/visa-services/VisaSidebarFilters.jsx';

export interface Props {
	title: string;
	description?: string;
	lang?: string;
	pathname?: string;
	headings?: any[];
	lastEdited?: string;
	showBreadcrumb?: boolean;
	currentSlug?: string;
}

const { 
	title, 
	description, 
	lang = 'en', 
	pathname,
	headings = [],
	lastEdited,
	showBreadcrumb = false,
	currentSlug
} = Astro.props;

// Get optimized menu data
const menuData = await getAllMenuData(lang);

// Get visa services for sidebar navigation
const allVisas = menuData?.allVisas || [];
const hasHeadings = headings && headings.length > 0;

// Get unique countries and visa types for filters from the menu data
const countries = menuData?.visaCountries || [];
const visaTypes = menuData?.visaTypes || [];
---

<Layout title={title} description={description} lang={lang} pathname={pathname} menuData={menuData}>
	<div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 mt-[74px]">
		<div class="flex gap-8">
			<!-- Left Navigation Panel with Filters -->
			<aside class="hidden lg:block w-80 shrink-0">
				<div class="sticky top-32">
					<VisaSidebarFilters 
						client:load
						visas={allVisas}
						currentSlug={currentSlug || ''}
						lang={lang}
						countries={countries}
						visaTypes={visaTypes}
					/>
				</div>
			</aside>

			<!-- Main Content -->
			<article class="flex-1 min-w-0">
				<!-- Breadcrumb -->
				{showBreadcrumb && (
					<nav class="mb-6" aria-label="Breadcrumb">
						<ol class="flex items-center space-x-2 text-sm text-gray-500">
							<li><a href={`/${lang}`} class="hover:text-gray-700">{lang === 'es' ? 'Inicio' : 'Home'}</a></li>
							<li class="flex items-center">
								<span class="mx-2">/</span>
								<a href={`/${lang}/visas`} class="hover:text-gray-700">{lang === 'es' ? 'Visas' : 'Visas'}</a>
							</li>
							<li class="flex items-center">
								<span class="mx-2">/</span>
								<span class="text-gray-900">{title}</span>
							</li>
						</ol>
					</nav>
				)}

				<!-- Header -->
				<header class="mb-8">
					<h1 class="text-3xl sm:text-4xl font-light text-gray-900 mb-4">{title}</h1>
					{description && (
						<p class="text-lg text-gray-600 max-w-3xl mb-4">
							{description}
						</p>
					)}
					
					<!-- Meta information -->
					{lastEdited && (
						<div class="flex items-center gap-6 text-sm text-gray-500">
							<div class="flex items-center gap-2">
								<span class="w-2 h-2 bg-green-400 rounded-full"></span>
								<span>
									{lang === 'es' ? 'Última actualización' : 'Last updated'}: {new Date(lastEdited).toLocaleDateString(lang === 'es' ? 'es-ES' : 'en-US')}
								</span>
							</div>
						</div>
					)}
				</header>

				<!-- Content -->
				<div class="prose prose-lg max-w-none prose-headings:scroll-mt-20">
					<slot />
				</div>
			</article>

			<!-- Right Table of Contents -->
			{hasHeadings && (
				<aside class="hidden xl:block w-80 shrink-0">
					<div class="sticky top-32">
						<TableOfContents headings={headings} lang={lang} />
					</div>
				</aside>
			)}
		</div>
	</div>
</Layout>

<style>
	/* Smooth scroll behavior for the entire page */
	html {
		scroll-behavior: smooth;
	}

	/* Ensure headings have proper scroll margin for navbar offset */
	:global(h2, h3, h4, h5, h6) {
		scroll-margin-top: 120px;
	}
</style>